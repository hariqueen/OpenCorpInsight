<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ page isELIgnored="true" %>
<%@ page import="com.corpIns.dto.User" %>
<%
    // Î°úÍ∑∏Ïù∏ Ï≤¥ÌÅ¨ - Î°úÍ∑∏Ïù∏ÌïòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Î¶¨Îã§Ïù¥Î†âÌä∏
    User loginUser = (User) session.getAttribute("loginUser");
    if (loginUser == null) {
        response.sendRedirect(request.getContextPath() + "/login");
        return;
    }
%>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Í∏∞ÏóÖ ÎπÑÍµê Î∂ÑÏÑù</title>
    <style>
       * {
           margin: 0;
           padding: 0;
           box-sizing: border-box;
       }

       body {
           font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
           background: linear-gradient(135deg, #0d0f2f 0%, #1c1f4a 100%);
           color: #e0e0e0;
           min-height: 100vh;
       }

       /* Ìó§Îçî */
       .header {
           display: flex;
           justify-content: space-between;
           align-items: center;
           padding: 20px 40px;
       }

       .user-icon {
           width: 50px;
           height: 50px;
           background: rgba(255, 255, 255, 0.1);
           border-radius: 50%;
           display: flex;
           align-items: center;
           justify-content: center;
           backdrop-filter: blur(8px);
           font-size: 24px;
       }

       /* AI Ï±ÑÌåÖ Î≤ÑÌäº */
       .ai-chat {
           position: fixed;
           bottom: 30px;
           right: 30px;
           width: 60px;
           height: 60px;
           background: linear-gradient(135deg, #00e0ff, #0066cc);
           border-radius: 50%;
           display: flex;
           align-items: center;
           justify-content: center;
           font-weight: bold;
           font-size: 18px;
           cursor: pointer;
           box-shadow: 0 6px 20px rgba(0, 224, 255, 0.5);
           transition: transform 0.2s, box-shadow 0.2s;
       }

       .ai-chat:hover {
           transform: scale(1.15);
           box-shadow: 0 8px 30px rgba(0, 224, 255, 0.7);
       }

       /* Î©îÏù∏ Ïª®ÌÖåÏù¥ÎÑà */
       .main-container {
           max-width: 1200px;
           margin: 0 auto;
           padding: 20px;
       }

       /* VS ÌÉÄÏù¥ÌãÄ */
       .vs-header {
           text-align: center;
           margin-bottom: 40px;
       }

       .vs-title {
           font-size: 56px;
           font-weight: 400;
           letter-spacing: 10px;
           color: #00e0ff;
           text-shadow: 0 0 10px #00e0ff, 0 0 20px #00e0ff;
       }

       /* Í∏∞ÏóÖ Ïù¥Î¶Ñ */
       .companies-header {
           display: flex;
           justify-content: space-between;
           align-items: center;
           margin-bottom: 30px;
           padding: 0 50px;
       }

       .company-name {
           font-size: 32px;
           font-weight: 600;
           text-align: center;
       }

       .company-left {
           color: #ff6a95;
           text-shadow: 0 0 5px #ff6a95;
       }

       .company-right {
           color: #4ef0e0;
           text-shadow: 0 0 5px #4ef0e0;
       }

       /* ÎπÑÍµê Ïπ¥Îìú */
       .comparison-grid {
           display: flex;
           flex-direction: column;
           gap: 25px;
       }

       .comparison-row {
           display: flex;
           justify-content: space-between;
           align-items: center;
           gap: 40px;
       }

       .metric-card {
           flex: 1;
           background: rgba(255, 255, 255, 0.05);
           backdrop-filter: blur(12px);
           border-radius: 20px;
           padding: 25px;
           text-align: center;
           border: 1px solid rgba(255, 255, 255, 0.15);
           position: relative;
           transition: transform 0.2s, box-shadow 0.2s;
       }

       .metric-card.winner {
           background: rgba(255, 255, 255, 0.15);
           box-shadow: 0 8px 30px rgba(255, 255, 255, 0.1);
           transform: translateY(-3px);
       }

       .metric-card.left {
           background: linear-gradient(135deg, rgba(255, 106, 149, 0.15), rgba(255, 106, 149, 0.05));
       }

       .metric-card.right {
           background: linear-gradient(135deg, rgba(78, 240, 224, 0.15), rgba(78, 240, 224, 0.05));
       }

       .metric-label {
           font-size: 16px;
           opacity: 0.8;
           margin-bottom: 10px;
           font-weight: 500;
       }

       .metric-value {
           font-size: 28px;
           font-weight: 700;
           margin-bottom: 5px;
       }

       .metric-unit {
           font-size: 14px;
           opacity: 0.7;
       }

       /* VS Divider */
       .vs-divider {
           width: 60px;
           height: 60px;
           background: rgba(255, 255, 255, 0.1);
           border-radius: 50%;
           display: flex;
           align-items: center;
           justify-content: center;
           font-size: 20px;
           font-weight: bold;
           backdrop-filter: blur(10px);
           border: 2px solid rgba(255, 255, 255, 0.2);
       }

       /* ÏäπÏûê ÌëúÏãú */
       .winner-indicator {
           position: absolute;
           top: -5px;
           right: -5px;
           width: 32px;
           height: 32px;
           background: linear-gradient(135deg, #ffd700, #ffed4e);
           border-radius: 50%;
           display: flex;
           align-items: center;
           justify-content: center;
           font-size: 16px;
           color: #333;
           box-shadow: 0 0 5px #ffd700;
       }

       /* Î∂ÑÏÑù Î≤ÑÌäº */
       .analysis-button {
           display: block;
           margin: 40px auto;
           padding: 15px 40px;
           background: linear-gradient(135deg, #00e0ff, #0066cc);
           border: none;
           border-radius: 30px;
           color: white;
           font-size: 18px;
           font-weight: 600;
           cursor: pointer;
           transition: all 0.3s ease;
           box-shadow: 0 6px 20px rgba(0, 224, 255, 0.4);
       }

       .analysis-button:hover {
           transform: translateY(-3px);
           box-shadow: 0 8px 30px rgba(0, 224, 255, 0.6);
       }

       /* ÏöîÏïΩ ÏÑπÏÖò */
       .summary-section {
           background: rgba(255, 255, 255, 0.05);
           backdrop-filter: blur(12px);
           border-radius: 20px;
           padding: 30px;
           margin-top: 40px;
           border: 1px solid rgba(255, 255, 255, 0.1);
       }

       .summary-title {
           font-size: 24px;
           font-weight: 600;
           margin-bottom: 20px;
           text-align: center;
       }

       .summary-stats {
           display: flex;
           justify-content: space-around;
           gap: 20px;
       }

       .summary-item {
           text-align: center;
           flex: 1;
       }

       .summary-item .label {
           font-size: 14px;
           opacity: 0.8;
           margin-bottom: 8px;
       }

       .summary-item .value {
           font-size: 20px;
           font-weight: 700;
       }

       .summary-item .winner {
           color: #ffd700;
       }

       .loading-spinner {
           color: #888;
           font-size: 14px;
           animation: pulse 1.5s infinite;
       }

       @keyframes pulse {
           0%, 100% { opacity: 0.5; }
           50% { opacity: 1; }
       }

       /* Î∞òÏùëÌòï */
       @media (max-width: 768px) {
           .companies-header {
               padding: 0 20px;
           }

           .company-name {
               font-size: 24px;
           }

           .comparison-row {
               gap: 20px;
               flex-direction: column;
           }

           .metric-card {
               padding: 20px;
           }

           .metric-value {
               font-size: 24px;
           }

           .vs-divider {
               width: 50px;
               height: 50px;
               font-size: 16px;
           }
       }

    </style>
</head>
<body>
    <div class="header">
        <div></div>
        <div class="user-icon">üë§</div>
    </div>

    <div class="main-container">
        <div class="vs-header">
            <h1 class="vs-title">VS</h1>
        </div>

        <div class="companies-header">
            <div class="company-name company-left" id="company1Name"></div>
            <div class="company-name company-right" id="company2Name"></div>
        </div>

        <div class="comparison-grid">
            <!-- Îß§Ï∂úÏï° ÎπÑÍµê -->
            <div class="comparison-row">
                <div class="metric-card left" id="revenue1">
                    <div class="metric-label">Îß§Ï∂úÏï°</div>
                    <div class="metric-value">258.9Ï°∞</div>
                    <div class="metric-unit">Ïõê</div>
                </div>
                <div class="vs-divider">VS</div>
                <div class="metric-card right" id="revenue2">
                    <div class="metric-label">Îß§Ï∂úÏï°</div>
                    <div class="metric-value">7.4Ï°∞</div>
                    <div class="metric-unit">Ïõê</div>
                </div>
            </div>

            <!-- ÏòÅÏóÖÏù¥Ïùµ ÎπÑÍµê -->
            <div class="comparison-row">
                <div class="metric-card left" id="operating1">
                    <div class="metric-label">ÏòÅÏóÖÏù¥Ïùµ</div>
                    <div class="metric-value">6.6Ï°∞</div>
                    <div class="metric-unit">Ïõê</div>
                </div>
                <div class="vs-divider">VS</div>
                <div class="metric-card right" id="operating2">
                    <div class="metric-label">ÏòÅÏóÖÏù¥Ïùµ</div>
                    <div class="metric-value">1.6Ï°∞</div>
                    <div class="metric-unit">Ïõê</div>
                </div>
            </div>

            <!-- ÏàúÏù¥Ïùµ ÎπÑÍµê -->
            <div class="comparison-row">
                <div class="metric-card left" id="net1">
                    <div class="metric-label">ÏàúÏù¥Ïùµ</div>
                    <div class="metric-value">15.5Ï°∞</div>
                    <div class="metric-unit">Ïõê</div>
                </div>
                <div class="vs-divider">VS</div>
                <div class="metric-card right" id="net2">
                    <div class="metric-label">ÏàúÏù¥Ïùµ</div>
                    <div class="metric-value">1.4Ï°∞</div>
                    <div class="metric-unit">Ïõê</div>
                </div>
            </div>

            <!-- Ï¥ùÏûêÏÇ∞ ÎπÑÍµê -->
            <div class="comparison-row">
                <div class="metric-card left" id="assets1">
                    <div class="metric-label">Ï¥ùÏûêÏÇ∞</div>
                    <div class="metric-value">455.9Ï°∞</div>
                    <div class="metric-unit">Ïõê</div>
                </div>
                <div class="vs-divider">VS</div>
                <div class="metric-card right" id="assets2">
                    <div class="metric-label">Ï¥ùÏûêÏÇ∞</div>
                    <div class="metric-value">30.3Ï°∞</div>
                    <div class="metric-unit">Ïõê</div>
                </div>
            </div>

            <!-- ROE ÎπÑÍµê -->
            <div class="comparison-row">
                <div class="metric-card left" id="roe1">
                    <div class="metric-label">ROE</div>
                    <div class="metric-value">4.3%</div>
                    <div class="metric-unit">ÏûêÍ∏∞ÏûêÎ≥∏Ïù¥ÏùµÎ•†</div>
                </div>
                <div class="vs-divider">VS</div>
                <div class="metric-card right" id="roe2">
                    <div class="metric-label">ROE</div>
                    <div class="metric-value">5.3%</div>
                    <div class="metric-unit">ÏûêÍ∏∞ÏûêÎ≥∏Ïù¥ÏùµÎ•†</div>
                </div>
            </div>

            <!-- Î∂ÄÏ±ÑÎπÑÏú® ÎπÑÍµê -->
            <div class="comparison-row">
                <div class="metric-card left" id="debt1">
                    <div class="metric-label">Î∂ÄÏ±ÑÎπÑÏú®</div>
                    <div class="metric-value">25.4%</div>
                    <div class="metric-unit">ÏïàÏ†ïÏÑ±</div>
                </div>
                <div class="vs-divider">VS</div>
                <div class="metric-card right" id="debt2">
                    <div class="metric-label">Î∂ÄÏ±ÑÎπÑÏú®</div>
                    <div class="metric-value">12.0%</div>
                    <div class="metric-unit">ÏïàÏ†ïÏÑ±</div>
                </div>
            </div>
        </div>

        <div class="summary-section">
            <h3 class="summary-title">ÎπÑÍµê ÏöîÏïΩ</h3>
            <div class="summary-stats">
                <div class="summary-item">
                    <div class="label">Îß§Ï∂ú Ïö∞ÏúÑ</div>
                    <div class="value winner" id="revenueWinner">
                        <div class="loading-spinner" id="revenueLoading">Î∂ÑÏÑùÏ§ë...</div>
                    </div>
                </div>
                <div class="summary-item">
                    <div class="label">ÏàòÏùµÏÑ± Ïö∞ÏúÑ</div>
                    <div class="value winner" id="profitWinner">
                        <div class="loading-spinner" id="profitLoading">Î∂ÑÏÑùÏ§ë...</div>
                    </div>
                </div>
                <div class="summary-item">
                    <div class="label">ÏûêÏÇ∞ Í∑úÎ™®</div>
                    <div class="value winner" id="assetWinner">
                        <div class="loading-spinner" id="assetLoading">Î∂ÑÏÑùÏ§ë...</div>
                    </div>
                </div>
                <div class="summary-item">
                    <div class="label">ÏïàÏ†ïÏÑ± Ïö∞ÏúÑ</div>
                    <div class="value winner" id="stabilityWinner">
                        <div class="loading-spinner" id="stabilityLoading">Î∂ÑÏÑùÏ§ë...</div>
                    </div>
                </div>
            </div>
        </div>

        <button class="analysis-button" onclick="openDetailAnalysis()">
            Îã§Î•∏ Í∏∞ÏóÖ ÎπÑÍµêÌïòÍ∏∞
        </button>
    </div>

    <div class="ai-chat" onclick="openAIChat()">
        AI
    </div>

    <script>
        // URL ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú Í∏∞ÏóÖ Ï†ïÎ≥¥ ÏùΩÍ∏∞
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // ÏÑ†ÌÉùÎêú Í∏∞ÏóÖ Ï†ïÎ≥¥
        const selectedCompanies = {
            company1: {
                corp_code: getUrlParameter('corp1Code'),
                corp_name: getUrlParameter('corp1Name'),
                ceo_name: getUrlParameter('corp1Ceo'),
                business_name: getUrlParameter('corp1Business')
            },
            company2: {
                corp_code: getUrlParameter('corp2Code'),
                corp_name: getUrlParameter('corp2Name'),
                ceo_name: getUrlParameter('corp2Ceo'),
                business_name: getUrlParameter('corp2Business')
            }
        };

        console.log('ÏÑ†ÌÉùÎêú Í∏∞ÏóÖÎì§:', selectedCompanies);

        // Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ (Ïã§Ï†úÎ°úÎäî APIÏóêÏÑú Î∞õÏïÑÏò¥)
        const comparisonData = {
            "comparison_info": {
                "company1": {"corp_name": selectedCompanies.company1.corp_name},
                "company2": {"corp_name": selectedCompanies.company2.corp_name}
            },
            "basic_financial_comparison": {
                "company1": {
                    "revenue": 258935494000000,
                    "operating_profit": 6566976000000,
                    "net_profit": 15487100000000,
                    "total_assets": 455905980000000
                },
                "company2": {
                    "revenue": 7445336000000,
                    "operating_profit": 1589013000000,
                    "net_profit": 1414258000000,
                    "total_assets": 30253085000000
                }
            },
            "financial_indicators_comparison": {
                "profitability": {
                    "company1": {"ROE": 4.311},
                    "company2": {"ROE": 5.312}
                },
                "stability": {
                    "company1": {"Î∂ÄÏ±ÑÎπÑÏú®": 25.36},
                    "company2": {"Î∂ÄÏ±ÑÎπÑÏú®": 11.98}
                }
            },
            "comparison_summary": {
                "revenue_comparison": {"winner": selectedCompanies.company1.corp_name},
                "profitability_comparison": {"winner": selectedCompanies.company1.corp_name},
                "asset_comparison": {"winner": selectedCompanies.company1.corp_name}
            }
        };

        function formatNumber(num) {
            if (num >= 1000000000000) {
                return (num / 1000000000000).toFixed(1) + 'Ï°∞';
            } else if (num >= 100000000) {
                return (num / 100000000).toFixed(0) + 'Ïñµ';
            }
            return num.toLocaleString();
        }

        function updateDashboard(data) {
            // Í∏∞ÏóÖÎ™Ö ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('company1Name').textContent = data.comparison_info.company1.corp_name;
            document.getElementById('company2Name').textContent = data.comparison_info.company2.corp_name;

            const basic = data.basic_financial_comparison;
            const indicators = data.financial_indicators_comparison;

            // Îß§Ï∂úÏï°
            document.querySelector('#revenue1 .metric-value').textContent = formatNumber(basic.company1.revenue);
            document.querySelector('#revenue2 .metric-value').textContent = formatNumber(basic.company2.revenue);

            // ÏòÅÏóÖÏù¥Ïùµ
            document.querySelector('#operating1 .metric-value').textContent = formatNumber(basic.company1.operating_profit);
            document.querySelector('#operating2 .metric-value').textContent = formatNumber(basic.company2.operating_profit);

            // ÏàúÏù¥Ïùµ
            document.querySelector('#net1 .metric-value').textContent = formatNumber(basic.company1.net_profit);
            document.querySelector('#net2 .metric-value').textContent = formatNumber(basic.company2.net_profit);

            // Ï¥ùÏûêÏÇ∞
            document.querySelector('#assets1 .metric-value').textContent = formatNumber(basic.company1.total_assets);
            document.querySelector('#assets2 .metric-value').textContent = formatNumber(basic.company2.total_assets);

            // ROE
            document.querySelector('#roe1 .metric-value').textContent = indicators.profitability.company1.ROE + '%';
            document.querySelector('#roe2 .metric-value').textContent = indicators.profitability.company2.ROE + '%';

            // Î∂ÄÏ±ÑÎπÑÏú®
            document.querySelector('#debt1 .metric-value').textContent = indicators.stability.company1['Î∂ÄÏ±ÑÎπÑÏú®'] + '%';
            document.querySelector('#debt2 .metric-value').textContent = indicators.stability.company2['Î∂ÄÏ±ÑÎπÑÏú®'] + '%';

            // Ïö∞ÏúÑ ÌëúÏãú
            highlightWinners(data);

            // ÏöîÏïΩ ÏóÖÎç∞Ïù¥Ìä∏ - Ïã§Ï†ú API ÏùëÎãµ Íµ¨Ï°∞Ïóê ÎßûÍ≤å ÏàòÏ†ï
            updateComparisonSummary(data);
        }

        function updateComparisonSummary(data) {
            try {
                const basic = data.basic_financial_comparison || {};
                const indicators = data.financial_indicators_comparison || {};
                const companyNames = [
                    data.comparison_info?.company1?.corp_name || data.basic_info?.company1?.name,
                    data.comparison_info?.company2?.corp_name || data.basic_info?.company2?.name
                ];

                // Îß§Ï∂ú Ïö∞ÏúÑ (Îß§Ï∂úÏï° Í∏∞Ï§Ä)
                let revenueWinner = '-';
                if (basic.company1?.revenue && basic.company2?.revenue) {
                    revenueWinner = basic.company1.revenue > basic.company2.revenue ? companyNames[0] : companyNames[1];
                }
                document.getElementById('revenueWinner').textContent = revenueWinner;

                // ÏàòÏùµÏÑ± Ïö∞ÏúÑ (ROE Í∏∞Ï§Ä)
                let profitWinner = '-';
                if (indicators.profitability?.company1?.ROE && indicators.profitability?.company2?.ROE) {
                    profitWinner = indicators.profitability.company1.ROE > indicators.profitability.company2.ROE ? companyNames[0] : companyNames[1];
                }
                document.getElementById('profitWinner').textContent = profitWinner;

                // ÏûêÏÇ∞ Í∑úÎ™® (Ï¥ùÏûêÏÇ∞ Í∏∞Ï§Ä)
                let assetWinner = '-';
                if (basic.company1?.total_assets && basic.company2?.total_assets) {
                    assetWinner = basic.company1.total_assets > basic.company2.total_assets ? companyNames[0] : companyNames[1];
                }
                document.getElementById('assetWinner').textContent = assetWinner;

                // ÏïàÏ†ïÏÑ± Ïö∞ÏúÑ (Î∂ÄÏ±ÑÎπÑÏú® Í∏∞Ï§Ä - ÎÇÆÏùÑÏàòÎ°ù Ï¢ãÏùå)
                let stabilityWinner = '-';
                if (indicators.stability?.company1?.['Î∂ÄÏ±ÑÎπÑÏú®'] && indicators.stability?.company2?.['Î∂ÄÏ±ÑÎπÑÏú®']) {
                    stabilityWinner = indicators.stability.company1['Î∂ÄÏ±ÑÎπÑÏú®'] < indicators.stability.company2['Î∂ÄÏ±ÑÎπÑÏú®'] ? companyNames[0] : companyNames[1];
                }
                document.getElementById('stabilityWinner').textContent = stabilityWinner;

            } catch (error) {
                console.error('ÎπÑÍµê ÏöîÏïΩ ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error);
                // Ïò§Î•ò Ïãú Í∏∞Î≥∏Í∞íÏúºÎ°ú ÏÑ§Ï†ï
                document.getElementById('revenueWinner').textContent = '-';
                document.getElementById('profitWinner').textContent = '-';
                document.getElementById('assetWinner').textContent = '-';
                document.getElementById('stabilityWinner').textContent = '-';
            }
        }

        function updateComparisonSummaryFromAPI(comparisonData) {
            try {
                console.log('API ÏùëÎãµÏúºÎ°ú ÎπÑÍµê ÏöîÏïΩ ÏóÖÎç∞Ïù¥Ìä∏:', comparisonData);
                
                const financialComparison = comparisonData.financial_comparison || {};
                const detailedRatios = comparisonData.detailed_ratios || {};
                const basicInfo = comparisonData.basic_info || {};
                
                const companyNames = [
                    basicInfo.company1?.name,
                    basicInfo.company2?.name
                ];

                // Îß§Ï∂ú Ïö∞ÏúÑ (financial_comparisonÏóêÏÑú Îß§Ï∂úÏï° ÎπÑÍµê)
                let revenueWinner = '-';
                const corp1Data = financialComparison[basicInfo.company1?.corp_code] || {};
                const corp2Data = financialComparison[basicInfo.company2?.corp_code] || {};
                
                if (corp1Data.Îß§Ï∂úÏï° && corp2Data.Îß§Ï∂úÏï°) {
                    revenueWinner = corp1Data.Îß§Ï∂úÏï° > corp2Data.Îß§Ï∂úÏï° ? companyNames[0] : companyNames[1];
                } else if (corp1Data.Îß§Ï∂úÏï° && !corp2Data.Îß§Ï∂úÏï°) {
                    revenueWinner = companyNames[0];
                } else if (!corp1Data.Îß§Ï∂úÏï° && corp2Data.Îß§Ï∂úÏï°) {
                    revenueWinner = companyNames[1];
                }
                
                // Î°úÎî© Ï†úÍ±∞ÌïòÍ≥† Í≤∞Í≥º ÌëúÏãú
                const revenueElement = document.getElementById('revenueWinner');
                const revenueLoading = document.getElementById('revenueLoading');
                if (revenueLoading) revenueLoading.remove();
                revenueElement.textContent = revenueWinner;

                // ÏàòÏùµÏÑ± Ïö∞ÏúÑ (ÏòÅÏóÖÏù¥ÏùµÎ•† ÎòêÎäî ROE ÎπÑÍµê)
                let profitWinner = '-';
                
                // 1ÏàúÏúÑ: ÏòÅÏóÖÏù¥ÏùµÎ•†(OPM) ÎπÑÍµê
                if (detailedRatios.company1?.OPM && detailedRatios.company2?.OPM) {
                    profitWinner = detailedRatios.company1.OPM > detailedRatios.company2.OPM ? companyNames[0] : companyNames[1];
                } else if (detailedRatios.company1?.OPM && !detailedRatios.company2?.OPM) {
                    profitWinner = companyNames[0];
                } else if (!detailedRatios.company1?.OPM && detailedRatios.company2?.OPM) {
                    profitWinner = companyNames[1];
                }
                // 2ÏàúÏúÑ: ROE ÎπÑÍµê (ÏòÅÏóÖÏù¥ÏùµÎ•†Ïù¥ ÏóÜÏùÑ Í≤ΩÏö∞)
                else if (detailedRatios.company1?.ROE && detailedRatios.company2?.ROE) {
                    profitWinner = detailedRatios.company1.ROE > detailedRatios.company2.ROE ? companyNames[0] : companyNames[1];
                } else if (detailedRatios.company1?.ROE && !detailedRatios.company2?.ROE) {
                    profitWinner = companyNames[0];
                } else if (!detailedRatios.company1?.ROE && detailedRatios.company2?.ROE) {
                    profitWinner = companyNames[1];
                }
                
                // Î°úÎî© Ï†úÍ±∞ÌïòÍ≥† Í≤∞Í≥º ÌëúÏãú
                const profitElement = document.getElementById('profitWinner');
                const profitLoading = document.getElementById('profitLoading');
                if (profitLoading) profitLoading.remove();
                profitElement.textContent = profitWinner;

                // ÏûêÏÇ∞ Í∑úÎ™® - APIÏóêÏÑú Ï¥ùÏûêÏÇ∞ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎØÄÎ°ú Îß§Ï∂úÏï°ÏúºÎ°ú ÎåÄÏ≤¥
                let assetWinner = '-';
                if (corp1Data.Îß§Ï∂úÏï° && corp2Data.Îß§Ï∂úÏï°) {
                    assetWinner = corp1Data.Îß§Ï∂úÏï° > corp2Data.Îß§Ï∂úÏï° ? companyNames[0] : companyNames[1];
                } else if (corp1Data.Îß§Ï∂úÏï° && !corp2Data.Îß§Ï∂úÏï°) {
                    assetWinner = companyNames[0];
                } else if (!corp1Data.Îß§Ï∂úÏï° && corp2Data.Îß§Ï∂úÏï°) {
                    assetWinner = companyNames[1];
                }
                
                // Î°úÎî© Ï†úÍ±∞ÌïòÍ≥† Í≤∞Í≥º ÌëúÏãú
                const assetElement = document.getElementById('assetWinner');
                const assetLoading = document.getElementById('assetLoading');
                if (assetLoading) assetLoading.remove();
                assetElement.textContent = assetWinner;

                // ÏïàÏ†ïÏÑ± Ïö∞ÏúÑ (detailed_ratiosÏóêÏÑú Î∂ÄÏ±ÑÎπÑÏú® ÎπÑÍµê - ÎÇÆÏùÑÏàòÎ°ù Ï¢ãÏùå)
                let stabilityWinner = '-';
                if (detailedRatios.company1?.Î∂ÄÏ±ÑÎπÑÏú® && detailedRatios.company2?.Î∂ÄÏ±ÑÎπÑÏú®) {
                    stabilityWinner = detailedRatios.company1.Î∂ÄÏ±ÑÎπÑÏú® < detailedRatios.company2.Î∂ÄÏ±ÑÎπÑÏú® ? companyNames[0] : companyNames[1];
                }
                
                // Î°úÎî© Ï†úÍ±∞ÌïòÍ≥† Í≤∞Í≥º ÌëúÏãú
                const stabilityElement = document.getElementById('stabilityWinner');
                const stabilityLoading = document.getElementById('stabilityLoading');
                if (stabilityLoading) stabilityLoading.remove();
                stabilityElement.textContent = stabilityWinner;

                console.log('ÎπÑÍµê ÏöîÏïΩ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å:', {
                    revenueWinner, profitWinner, assetWinner, stabilityWinner
                });

            } catch (error) {
                console.error('API ÎπÑÍµê ÏöîÏïΩ ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error);
                // Ïò§Î•ò Ïãú Í∏∞Î≥∏Í∞íÏúºÎ°ú ÏÑ§Ï†ï
                document.getElementById('revenueWinner').textContent = '-';
                document.getElementById('profitWinner').textContent = '-';
                document.getElementById('assetWinner').textContent = '-';
                document.getElementById('stabilityWinner').textContent = '-';
            }
        }

        function highlightWinners(data) {
            const basic = data.basic_financial_comparison;
            const indicators = data.financial_indicators_comparison;

            // Îß§Ï∂úÏï° Ïö∞ÏúÑ
            if (basic.company1.revenue > basic.company2.revenue) {
                document.getElementById('revenue1').classList.add('winner');
                document.getElementById('revenue1').innerHTML += '<div class="winner-indicator">üëë</div>';
            } else {
                document.getElementById('revenue2').classList.add('winner');
                document.getElementById('revenue2').innerHTML += '<div class="winner-indicator">üëë</div>';
            }

            // ÏòÅÏóÖÏù¥Ïùµ Ïö∞ÏúÑ
            if (basic.company1.operating_profit > basic.company2.operating_profit) {
                document.getElementById('operating1').classList.add('winner');
                document.getElementById('operating1').innerHTML += '<div class="winner-indicator">üëë</div>';
            } else {
                document.getElementById('operating2').classList.add('winner');
                document.getElementById('operating2').innerHTML += '<div class="winner-indicator">üëë</div>';
            }

            // ÏàúÏù¥Ïùµ Ïö∞ÏúÑ
            if (basic.company1.net_profit > basic.company2.net_profit) {
                document.getElementById('net1').classList.add('winner');
                document.getElementById('net1').innerHTML += '<div class="winner-indicator">üëë</div>';
            } else {
                document.getElementById('net2').classList.add('winner');
                document.getElementById('net2').innerHTML += '<div class="winner-indicator">üëë</div>';
            }

            // Ï¥ùÏûêÏÇ∞ Ïö∞ÏúÑ
            if (basic.company1.total_assets > basic.company2.total_assets) {
                document.getElementById('assets1').classList.add('winner');
                document.getElementById('assets1').innerHTML += '<div class="winner-indicator">üëë</div>';
            } else {
                document.getElementById('assets2').classList.add('winner');
                document.getElementById('assets2').innerHTML += '<div class="winner-indicator">üëë</div>';
            }

            // ROE Ïö∞ÏúÑ
            if (indicators.profitability.company1.ROE > indicators.profitability.company2.ROE) {
                document.getElementById('roe1').classList.add('winner');
                document.getElementById('roe1').innerHTML += '<div class="winner-indicator">üëë</div>';
            } else {
                document.getElementById('roe2').classList.add('winner');
                document.getElementById('roe2').innerHTML += '<div class="winner-indicator">üëë</div>';
            }

            // Î∂ÄÏ±ÑÎπÑÏú® Ïö∞ÏúÑ (ÎÇÆÏùÄ Í≤ÉÏù¥ Ï¢ãÏùå)
            if (indicators.stability.company1['Î∂ÄÏ±ÑÎπÑÏú®'] < indicators.stability.company2['Î∂ÄÏ±ÑÎπÑÏú®']) {
                document.getElementById('debt1').classList.add('winner');
                document.getElementById('debt1').innerHTML += '<div class="winner-indicator">üëë</div>';
            } else {
                document.getElementById('debt2').classList.add('winner');
                document.getElementById('debt2').innerHTML += '<div class="winner-indicator">üëë</div>';
            }
        }

        function openDetailAnalysis() {
            alert('Í∏∞ÏóÖ Î∂ÑÏÑù ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.');
            window.location.href = '/compare';
        }

        function openAIChat() {
            alert('AI Ï±ÑÌåÖÏùÑ ÏãúÏûëÌï©ÎãàÎã§.');
        }

        // Í∏∞ÏóÖ ÎπÑÍµê Îç∞Ïù¥ÌÑ∞ Î°úÎìú (localStorage Ïö∞ÏÑ†, Ïã§Ìå® Ïãú API Ìò∏Ï∂ú)
        async function loadRealCompanyData() {
            try {
                console.log('Í∏∞ÏóÖ ÎπÑÍµê Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò§Îäî Ï§ë...');
                
                // Ïù¥Ï†Ñ Ï∫êÏãú Ï†ïÎ¶¨ (Í∏∞ÏóÖ ÏΩîÎìúÎ≥Ñ ÌÇ§Í∞Ä ÏïÑÎãå Ïù¥Ï†Ñ Î∞©ÏãùÏùò Ï∫êÏãú)
                const oldCache = localStorage.getItem('comparisonResult');
                if (oldCache) {
                    console.log('Ïù¥Ï†Ñ Ï∫êÏãú Ï†úÍ±∞');
                    localStorage.removeItem('comparisonResult');
                }
                
                // 1. localStorageÏóêÏÑú ÎπÑÍµê Í≤∞Í≥º ÌôïÏù∏ (Í∏∞ÏóÖ ÏΩîÎìúÎ≥ÑÎ°ú Íµ¨Î∂Ñ)
                const comparisonKey = `comparisonResult_${selectedCompanies.company1.corp_code}_${selectedCompanies.company2.corp_code}`;
                const storedComparison = localStorage.getItem(comparisonKey);
                if (storedComparison) {
                    try {
                        const comparisonData = JSON.parse(storedComparison);
                        console.log('‚úÖ localStorageÏóêÏÑú ÎπÑÍµê Îç∞Ïù¥ÌÑ∞ Î°úÎìú:', comparisonData);
                        
                        // Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Ïùò Í∏∞ÏóÖ ÏΩîÎìúÍ∞Ä ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Í∏∞ÏóÖÍ≥º ÏùºÏπòÌïòÎäîÏßÄ ÌôïÏù∏
                        const storedCorp1 = comparisonData.basic_info?.company1?.corp_code;
                        const storedCorp2 = comparisonData.basic_info?.company2?.corp_code;
                        
                        if (storedCorp1 === selectedCompanies.company1.corp_code && 
                            storedCorp2 === selectedCompanies.company2.corp_code) {
                            // ÎπÑÍµê Îç∞Ïù¥ÌÑ∞Î•º ÌôîÎ©¥Ïóê ÌëúÏãú
                            displayComparisonResults(comparisonData);
                            return;
                        } else {
                            console.log('‚ö†Ô∏è Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Ïùò Í∏∞ÏóÖ ÏΩîÎìúÍ∞Ä ÌòÑÏû¨ ÏÑ†ÌÉùÍ≥º Îã§Î¶Ñ, ÏÉàÎ°ú Î°úÎìú');
                            localStorage.removeItem(comparisonKey);
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è localStorage Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ïã§Ìå®:', e);
                        localStorage.removeItem(comparisonKey);
                    }
                }
                
                // 2. localStorageÏóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ API Ìò∏Ï∂ú
                console.log('localStorageÏóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏñ¥ API Ìò∏Ï∂ú ÏãúÏûë');
                
                // ÎèôÏ†Å ÌôòÍ≤Ω ÏÑ§Ï†ï Î°úÎìú
                let API_BASE_URL = 'http://localhost:5001'; // Í∏∞Î≥∏Í∞í
                
                try {
                    const configUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                        ? 'http://localhost:5001/api/config' 
                        : `http://${window.location.hostname}:5001/api/config`;
                        
                    const configResponse = await fetch(configUrl);
                    if (configResponse.ok) {
                        const configResult = await configResponse.json();
                        if (configResult.status === 'success') {
                            API_BASE_URL = configResult.data.api_base_url;
                            console.log('ÌôòÍ≤Ω ÏÑ§Ï†ï Î°úÎìú ÏÑ±Í≥µ:', configResult.data);
                        }
                    }
                } catch (error) {
                    console.warn('ÌôòÍ≤Ω ÏÑ§Ï†ï Î°úÎìú Ïã§Ìå®, Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©:', error);
                    // Ìè¥Î∞±: Í∏∞Ï°¥ Î°úÏßÅ ÏÇ¨Ïö©
                    API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                        ? 'http://localhost:5001' 
                        : 'http://43.203.170.37:5001';
                }
                
                // Í∏∞ÏóÖ ÎπÑÍµê API Ìò∏Ï∂ú
                const response = await fetch(`${API_BASE_URL}/api/compare-companies`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        corp_codes: [selectedCompanies.company1.corp_code, selectedCompanies.company2.corp_code],
                        company_names: [selectedCompanies.company1.corp_name, selectedCompanies.company2.corp_name]
                    })
                });

                if (!response.ok) {
                    throw new Error('Í∏∞ÏóÖ ÎπÑÍµê Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
                }

                const comparisonData = await response.json();
                console.log('APIÏóêÏÑú ÎπÑÍµê Îç∞Ïù¥ÌÑ∞ Î°úÎìú:', comparisonData);
                
                // ÎπÑÍµê Îç∞Ïù¥ÌÑ∞Î•º ÌôîÎ©¥Ïóê ÌëúÏãú
                displayComparisonResults(comparisonData);

            } catch (error) {
                console.error('Í∏∞ÏóÖ ÎπÑÍµê Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                alert('Í∏∞ÏóÖ ÎπÑÍµê Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // ÎπÑÍµê Í≤∞Í≥ºÎ•º ÌôîÎ©¥Ïóê ÌëúÏãúÌïòÎäî Ìï®Ïàò
        function displayComparisonResults(comparisonData) {
            try {
                console.log('ÎπÑÍµê Í≤∞Í≥º ÌôîÎ©¥ ÌëúÏãú ÏãúÏûë:', comparisonData);
                
                const basicInfo = comparisonData.basic_info || {};
                const financialComparison = comparisonData.financial_comparison || {};
                const detailedRatios = comparisonData.detailed_ratios || {};
                const investmentGrades = comparisonData.investment_grades || {};
                const comparisonSummary = comparisonData.comparison_summary || {};
                
                // Í∏∞ÏóÖ Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                updateCompanyBasicInfo(basicInfo);
                
                // Ïû¨Î¨¥ ÎπÑÍµê Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                updateFinancialComparisonCharts(financialComparison, detailedRatios);
                
                // Ìà¨Ïûê Îì±Í∏â ÌëúÏãú
                updateInvestmentGrades(investmentGrades);
                
                // ÎπÑÍµê ÏöîÏïΩ ÌëúÏãú
                updateComparisonSummaryFromAPI(comparisonData);
                
                console.log('ÎπÑÍµê Í≤∞Í≥º ÌôîÎ©¥ ÌëúÏãú ÏôÑÎ£å');
                
            } catch (error) {
                console.error('ÎπÑÍµê Í≤∞Í≥º ÌëúÏãú Ï§ë Ïò§Î•ò:', error);
            }
        }

        // Í∏∞ÏóÖ Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updateCompanyBasicInfo(basicInfo) {
            try {
                // Í∏∞ÏóÖÎ™Ö ÏóÖÎç∞Ïù¥Ìä∏
                const company1Name = basicInfo.company1?.name || selectedCompanies.company1.corp_name;
                const company2Name = basicInfo.company2?.name || selectedCompanies.company2.corp_name;
                
                // ÌéòÏù¥ÏßÄ Ï†úÎ™© ÏóÖÎç∞Ïù¥Ìä∏
                document.title = company1Name + ' vs ' + company2Name + ' - Í∏∞ÏóÖ ÎπÑÍµê Î∂ÑÏÑù';
                
                // ÌôîÎ©¥Ïùò Í∏∞ÏóÖÎ™Ö ÏßÅÏ†ë ÏóÖÎç∞Ïù¥Ìä∏
                const company1Element = document.getElementById('company1Name');
                const company2Element = document.getElementById('company2Name');
                
                if (company1Element) {
                    company1Element.textContent = company1Name;
                }
                if (company2Element) {
                    company2Element.textContent = company2Name;
                }
                
                console.log('Í∏∞ÏóÖ Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å:', { company1Name, company2Name });
                
            } catch (error) {
                console.error('Í∏∞ÏóÖ Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®:', error);
            }
        }

        // Ïû¨Î¨¥ ÎπÑÍµê Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
        function updateFinancialComparisonCharts(financialComparison, detailedRatios) {
            try {
                console.log('Ïû¨Î¨¥ ÎπÑÍµê Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏:', { financialComparison, detailedRatios });
                
                // Í∏∞Ï°¥ Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ Î°úÏßÅÏùÑ ÏÉàÎ°úÏö¥ Îç∞Ïù¥ÌÑ∞Î°ú ÍµêÏ≤¥
                const company1Data = detailedRatios.company1 || {};
                const company2Data = detailedRatios.company2 || {};
                
                // Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞ Íµ¨ÏÑ±
                const chartData = {
                    company1: {
                        name: selectedCompanies.company1.corp_name,
                        data: company1Data
                    },
                    company2: {
                        name: selectedCompanies.company2.corp_name,
                        data: company2Data
                    }
                };
                
                // Í∏∞Ï°¥ Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò Ìò∏Ï∂ú (ÏûàÎã§Î©¥)
                if (typeof updateChartsWithNewData === 'function') {
                    updateChartsWithNewData(chartData);
                } else {
                    console.log('Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®ÏàòÍ∞Ä ÏóÜÏñ¥ Îç∞Ïù¥ÌÑ∞Îßå Î°úÍ∑∏ Ï∂úÎ†•:', chartData);
                }
                
            } catch (error) {
                console.error('Ïû¨Î¨¥ ÎπÑÍµê Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®:', error);
            }
        }

        // Ìà¨Ïûê Îì±Í∏â ÌëúÏãú
        function updateInvestmentGrades(investmentGrades) {
            try {
                const company1Grade = investmentGrades.company1?.grade || {};
                const company2Grade = investmentGrades.company2?.grade || {};
                
                console.log('Ìà¨Ïûê Îì±Í∏â ÏóÖÎç∞Ïù¥Ìä∏:', { company1Grade, company2Grade });
                
                // Ìà¨Ïûê Îì±Í∏â ÌëúÏãú ÏòÅÏó≠Ïù¥ ÏûàÎã§Î©¥ ÏóÖÎç∞Ïù¥Ìä∏
                const gradeElements = document.querySelectorAll('.investment-grade, .grade-display');
                if (gradeElements.length > 0) {
                    gradeElements.forEach((el, index) => {
                        const grade = index === 0 ? company1Grade : company2Grade;
                        if (grade.grade) {
                            el.textContent = `Ìà¨ÏûêÎì±Í∏â: ${grade.grade} (${grade.score}Ï†ê)`;
                            el.style.color = grade.color || '#333';
                        }
                    });
                }
                
            } catch (error) {
                console.error('Ìà¨Ïûê Îì±Í∏â ÌëúÏãú Ïã§Ìå®:', error);
            }
        }

        // ÎπÑÍµê ÏöîÏïΩ ÌëúÏãú
        function updateComparisonSummary(comparisonSummary, basicInfo) {
            try {
                console.log('ÎπÑÍµê ÏöîÏïΩ ÌëúÏãú:', comparisonSummary);
                
                const winnerCategories = comparisonSummary.winner_categories || {};
                const overallWinner = comparisonSummary.overall_winner;
                const keyInsights = comparisonSummary.key_insights || [];
                
                // Ï†ÑÏ≤¥ ÏäπÏûê ÌëúÏãú
                if (overallWinner && overallWinner !== 'tie') {
                    const winnerName = overallWinner === 'company1' 
                        ? basicInfo.company1?.name || selectedCompanies.company1.corp_name
                        : basicInfo.company2?.name || selectedCompanies.company2.corp_name;
                    
                    console.log(`Ï†ÑÏ≤¥ ÏäπÏûê: ${winnerName}`);
                }
                
                // Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÏäπÏûê ÌëúÏãú
                Object.entries(winnerCategories).forEach(([category, data]) => {
                    console.log(`${category}: ${data.winner} (${data.company1_value} vs ${data.company2_value})`);
                });
                
                // ÌïµÏã¨ Ïù∏ÏÇ¨Ïù¥Ìä∏ ÌëúÏãú
                keyInsights.forEach((insight, index) => {
                    console.log(`Ïù∏ÏÇ¨Ïù¥Ìä∏ ${index + 1}: ${insight}`);
                });
                
            } catch (error) {
                console.error('ÎπÑÍµê ÏöîÏïΩ ÌëúÏãú Ïã§Ìå®:', error);
            }
        }

        // Í∏∞Ï°¥ ÏΩîÎìúÏôÄÏùò Ìò∏ÌôòÏÑ±ÏùÑ ÏúÑÌïú ÎçîÎØ∏ Ìï®Ïàò
        function loadOldComparisonData() {
            try {
                console.log('Í∏∞Ï°¥ ÎπÑÍµê Îç∞Ïù¥ÌÑ∞ Î°úÎìú (Ìò∏ÌôòÏÑ±)');

                // API ÏùëÎãµÏóêÏÑú financial_data Ï∂îÏ∂ú (ÎåÄÏãúÎ≥¥Îìú ÏùëÎãµ Íµ¨Ï°∞Ïóê ÎßûÍ≤å)
                const data1 = response1.financial_data || response1.data?.financial_data || response1;
                const data2 = response2.financial_data || response2.data?.financial_data || response2;

                console.log('Ï∂îÏ∂úÎêú Ïû¨Î¨¥ Îç∞Ïù¥ÌÑ∞:', { data1, data2 });

                // Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Î°ú ÎåÄÏãúÎ≥¥Îìú ÏóÖÎç∞Ïù¥Ìä∏
                const realComparisonData = {
                    "comparison_info": {
                        "company1": {"corp_name": selectedCompanies.company1.corp_name},
                        "company2": {"corp_name": selectedCompanies.company2.corp_name}
                    },
                    "basic_financial_comparison": {
                        "company1": data1,
                        "company2": data2
                    },
                    "financial_indicators_comparison": {
                        "profitability": {
                            "company1": {"ROE": calculateROE(data1)},
                            "company2": {"ROE": calculateROE(data2)}
                        },
                        "stability": {
                            "company1": {"Î∂ÄÏ±ÑÎπÑÏú®": calculateDebtRatio(data1)},
                            "company2": {"Î∂ÄÏ±ÑÎπÑÏú®": calculateDebtRatio(data2)}
                        }
                    },
                    "comparison_summary": {
                        "revenue_comparison": {"winner": data1.revenue > data2.revenue ? selectedCompanies.company1.corp_name : selectedCompanies.company2.corp_name},
                        "profitability_comparison": {"winner": data1.net_profit > data2.net_profit ? selectedCompanies.company1.corp_name : selectedCompanies.company2.corp_name},
                        "asset_comparison": {"winner": data1.total_assets > data2.total_assets ? selectedCompanies.company1.corp_name : selectedCompanies.company2.corp_name}
                    }
                };

                updateDashboard(realComparisonData);

            } catch (error) {
                console.error('Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                console.log('Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞Î°ú ÎåÄÏãúÎ≥¥Îìú ÌëúÏãú');
                updateDashboard(comparisonData);
            }
        }

        // ROE Í≥ÑÏÇ∞ (ÏàúÏù¥Ïùµ / ÏûêÍ∏∞ÏûêÎ≥∏)
        function calculateROE(financialData) {
            const netProfit = financialData.net_profit || 0;
            const totalEquity = financialData.total_equity || 1;
            return ((netProfit / totalEquity) * 100).toFixed(2);
        }

        // Î∂ÄÏ±ÑÎπÑÏú® Í≥ÑÏÇ∞ (Ï¥ùÎ∂ÄÏ±Ñ / ÏûêÍ∏∞ÏûêÎ≥∏ * 100)
        function calculateDebtRatio(financialData) {
            const totalDebt = financialData.total_debt || 0;
            const totalEquity = financialData.total_equity || 1;
            return ((totalDebt / totalEquity) * 100).toFixed(2);
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
        window.onload = function() {
            // Ï¶âÏãú URL ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú Í∏∞ÏóÖÎ™Ö ÌëúÏãú
            updateCompanyNamesFromURL();
            
            // Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÎèÑ, Ïã§Ìå®Ïãú Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
            loadRealCompanyData();
        };

        // URL ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú Í∏∞ÏóÖÎ™ÖÏùÑ Ï¶âÏãú ÌëúÏãúÌïòÎäî Ìï®Ïàò
        function updateCompanyNamesFromURL() {
            const company1Name = selectedCompanies.company1.corp_name;
            const company2Name = selectedCompanies.company2.corp_name;
            
            if (company1Name && company2Name) {
                const company1Element = document.getElementById('company1Name');
                const company2Element = document.getElementById('company2Name');
                
                if (company1Element) {
                    company1Element.textContent = company1Name;
                }
                if (company2Element) {
                    company2Element.textContent = company2Name;
                }
                
                // ÌéòÏù¥ÏßÄ Ï†úÎ™©ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                document.title = company1Name + ' vs ' + company2Name + ' - Í∏∞ÏóÖ ÎπÑÍµê Î∂ÑÏÑù';
                
                console.log('URLÏóêÏÑú Í∏∞ÏóÖÎ™Ö Ï¶âÏãú ÌëúÏãú:', { company1Name, company2Name });
            }
        }

        // Ïã§Ï†ú API Îç∞Ïù¥ÌÑ∞Î°ú ÏóÖÎç∞Ïù¥Ìä∏ÌïòÎäî Ìï®Ïàò
        function loadComparisonData(apiData) {
            updateDashboard(apiData.data);
        }
    </script>
</body>
</html>